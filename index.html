<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuiz Interaktif BM Tahun 4</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
        }

        html, body {
            height: 100%;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .timer {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .content {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
        }

        .btn-secondary:hover {
            background: #1976D2;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #4CAF50;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .question-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .question-number {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        /* MCQ Styles */
        .mcq-options {
            margin-top: 15px;
        }

        .mcq-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .mcq-option:hover {
            background: #f0f0f0;
        }

        .mcq-option input[type="radio"] {
            margin-right: 10px;
        }

        /* Text Input Styles */
        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-top: 10px;
        }

        /* Order Question Styles */
        .order-container {
            margin-top: 15px;
        }

        .tokens-available {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .tokens-selected {
            background: #f3e5f5;
            padding: 15px;
            border-radius: 8px;
            min-height: 60px;
            border: 2px dashed #9c27b0;
        }

        .token {
            display: inline-block;
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .token:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .token.selected {
            background: #9c27b0;
        }

        .order-labels {
            margin-bottom: 10px;
            font-weight: bold;
        }

        /* Judge Question Styles */
        .judge-container {
            margin-top: 15px;
        }

        .judge-labels {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .judge-label {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: grab;
            user-select: none;
            transition: all 0.3s;
        }

        .judge-label.false {
            background: #f44336;
        }

        .judge-label:hover {
            transform: scale(1.05);
        }

        .judge-label.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .judge-statement {
            background: #f5f5f5;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 2px dashed #ddd;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
        }

        .judge-statement.drag-over {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .judge-statement .assigned-label {
            background: #4CAF50;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
        }

        .judge-statement .assigned-label.false {
            background: #f44336;
        }

        /* Results Styles */
        .results {
            text-align: center;
        }

        .score-display {
            font-size: 2rem;
            font-weight: bold;
            color: #4CAF50;
            margin: 20px 0;
        }

        .result-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: left;
        }

        .result-item.correct {
            border-left: 5px solid #4CAF50;
        }

        .result-item.incorrect {
            border-left: 5px solid #f44336;
        }

        .hidden {
            display: none;
        }

        /* Review Screen Styles */
        .review-question {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .review-question.correct {
            border-left: 5px solid #4CAF50;
        }

        .review-question.incorrect {
            border-left: 5px solid #f44336;
        }

        .review-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .review-status {
            margin-left: 10px;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
            color: white;
        }

        .review-status.correct {
            background: #4CAF50;
        }

        .review-status.incorrect {
            background: #f44336;
        }

        .review-content {
            margin-bottom: 15px;
        }

        .review-answers {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .user-answer {
            margin-bottom: 10px;
        }

        .correct-answer {
            margin-bottom: 10px;
        }

        .answer-label {
            font-weight: bold;
            margin-right: 8px;
        }

        .user-answer .answer-label {
            color: #666;
        }

        .correct-answer .answer-label {
            color: #4CAF50;
        }

        .incorrect .user-answer .answer-label {
            color: #f44336;
        }

        .review-options {
            margin-top: 10px;
        }

        .review-option {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .review-option.user-selected {
            background: #ffebee;
            border-color: #f44336;
        }

        .review-option.correct-answer {
            background: #e8f5e8;
            border-color: #4CAF50;
            font-weight: bold;
        }

        .review-option.both-selected {
            background: #e8f5e8;
            border-color: #4CAF50;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .timer {
                font-size: 1rem;
            }

            .judge-labels {
                flex-direction: column;
                align-items: center;
            }

            .token {
                margin: 3px;
                padding: 6px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 Kuiz Interaktif BM Tahun 4</h1>
            <div class="timer hidden" id="timer">⏱️ Masa: 00:00</div>
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="content">
            <h2>Selamat Datang!</h2>
            <p>Kuiz interaktif ini mengandungi pelbagai jenis soalan untuk menguji kemahiran Bahasa Melayu anda.</p>
            
            <div class="form-group">
                <label for="studentName">Nama Murid:</label>
                <input type="text" id="studentName" placeholder="Masukkan nama penuh anda" required>
            </div>
            
            <div class="form-group">
                <label for="studentClass">Kelas:</label>
                <input type="text" id="studentClass" placeholder="Contoh: 4 Bestari" required>
            </div>
            
            <div class="form-group">
                <label for="studentSchool">Nama Sekolah:</label>
                <input type="text" id="studentSchool" placeholder="Contoh: SK Taman Desa" required>
            </div>
            
            <button class="btn" id="startQuizBtn">🚀 Mula Kuiz</button>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="content hidden">
            <div id="questionsContainer"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" id="submitQuizBtn">📝 Hantar Jawapan</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultScreen" class="content hidden">
            <div class="results">
                <h2>🎉 Keputusan Kuiz</h2>
                <div class="score-display" id="scoreDisplay"></div>
                <div id="timeDisplay"></div>
                <div id="detailedResults"></div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" id="reviewAnswersBtn">🔍 Semak Jawapan</button>
                    <button class="btn" id="tryAgainBtn">🔄 Cuba Lagi</button>
                    <button class="btn btn-secondary" id="printResultsBtn">🖨️ Cetak Keputusan</button>
                </div>
            </div>
        </div>

        <!-- Review Screen -->
        <div id="reviewScreen" class="content hidden">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>🔍 Semakan Jawapan</h2>
                <p>Lihat jawapan anda dan jawapan yang betul untuk setiap soalan.</p>
            </div>
            
            <div id="reviewContainer"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" id="backToResultsBtn">⬅️ Kembali ke Keputusan</button>
                <button class="btn" id="tryAgainFromReviewBtn">🔄 Cuba Lagi</button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxwGm_LGFvBasYbl-qRUsvmUMXmaHR7hds726BgKtx7kgUQAWncmO6XrF4snT15KJ8/exec";
        
        // Quiz data will be loaded here
        let QUIZ_DATA = {};
        
        // Global variables
        let startTime;
        let timerInterval;
        let quizData = {};
        let userAnswers = {};

        // Initialize quiz data
        function initializeQuizData() {
            const rawData = {"set_id":"BMThn4-SetA+Ramalan","sections":[
                {"t":"A (Tatabahasa)","i":"Pilih jawapan paling sesuai.","q":[
                {"y":"mcq","s":"Haziq memimpin warga emas ketika melintas ________.","o":["titi","jalan","jeti","jejantas"],"a":1},
                {"y":"mcq","s":"Tong sampah di dapur itu berbau ________ kerana minyak lama.","o":["hanyir","busuk","hamis","tengik"],"a":3},
                {"y":"mcq","s":"Pilih ayat yang betul.","o":["Bilakah kamu menyiapkan kerja sekolah ini?","Siapakah umur adik kamu?","Di manakah cara membuat roti canai?","Apakah kamu pergi ke pasar semalam?"],"a":0},
                {"y":"mcq","s":"Faiz _________ pulang ke kampung sejak bekerja di luar negara.","o":["tipis","kurang","sedikit","jarang"],"a":3},
                {"y":"mcq","s":"\"Aktiviti senaman ini dapat ______ otot kalian,\" kata Cikgu Aiman kepada murid-murid.","o":["membina","memupuk","mencungkil","melancarkan"],"a":0},
                {"y":"mcq","s":"Pilih ayat yang betul.","o":["Anak-anak Puan Nora pandai-pandai belaka.","Kanak-kanak itu bermain di halaman rumahnya.","Semua murid-murid perlu berbaris sebelum membeli makanan.","Para peserta pertandingan syarahan itu sedang menunggu gilirannya."],"a":1},
                {"y":"mcq","s":"Pilih ayat yang betul.","o":["Pasar raya itu akan mengadakan jualan murah selama seminggu.","Cikgu Aiman menerima sesikat bunga mawar bersempena dengan Hari Guru.","Pelbagai lauk-pauk yang enak dihidangkan dalam majlis kenduri kahwin itu.","Puan Juriah memeriksa tarikh luput yang terdapat dalam label makanan itu."],"a":2},
                {"y":"mcq","s":"Guru besar bukan sahaja pemurah, malahan ________ juga seorang yang peramah.","o":["dia","kamu","beliau","baginda"],"a":2},
                {"y":"mcq","s":"Bekas itu hendaklah ditutup dengan kemasnya supaya biskut di dalamnya tidak _________","o":["layu","lemau","lembut"],"a":1}]},
                {"t":"A (Pemahaman Petikan 1)","i":"Baca petikan dan jawab.","c":"Balqis menyambut hari lahir kesembilan di kelas 4 Cemerlang. Ibunya menyediakan makanan, Cikgu Zainab dan Rina menghias kelas. Mereka menyanyi lagu Selamat Hari Lahir. Haziq memberi botol, Mira memberi buku. Balqis turut dapat gelang, stokin, tabung, jam dan kek.","q":[
                {"y":"mcq","s":"Siapakah menyambut hari lahir?","o":["Haziq","Mira","Balqis","Rina"],"a":2},
                {"y":"mcq","s":"Pilih pernyataan benar.","o":["Rina beri botol.","Lagu Selamat Hari Lahir dinyanyikan bersama.","Cikgu Zainab dan Haziq hias kelas.","Ibu Balqis beri buku."],"a":1},
                {"y":"mcq","s":"Hadiah diterima Balqis kecuali —","o":["gelang dan tabung","buku dan jam","stokin dan botol","reben dan belon"],"a":3}]},
                {"t":"A (Pemahaman Petikan 2)","i":"Baca petikan dan jawab.","c":"Bunga Rafflesia atau bunga pakma merupakan tumbuhan yang sangat istimewa kerana tidak berdaun, bersaiz besar, dan berat. Bunga ini unik kerana tidak mempunyai akar untuk menyerap air dan mineral daripada tanah untuk diproses sebagai protein. Bunga ini menggunakan tisu-tisu yang kelihatan seperti tiub-tiub halus yang panjang untuk memasuki tumbuhan perumah.<br><br>Bunga ini amat besar dan warnanya kecokelatan. Kelopak bunga Rafflesia dihiasi bintik-bintik putih dan menghasilkan bau busuk seakan-akan bau daging atau bangkai yang reput. Bau busuk inilah yang menarik perhatian serangga dan hidupan lain untuk datang dan menjadi agen penyebar benih bunga Rafflesia.","q":[
                {"y":"mcq","s":"Apakah keunikan bunga Rafflesia?","o":["Bunga ini amat besar","Menghasilkan bau yang busuk","Menggunakan tiub-tiub halus untuk memasuki tumbuhan perumah","Tidak mempunyai akar untuk menyerap air dan mineral dari tanah"],"a":3},
                {"y":"mcq","s":"Pilih pernyataan yang benar tentang bunga Rafflesia.","o":["Benih bunga Rafflesia dihasilkan oleh serangga.","Kelopak bunga Rafflesia mempunyai bintik-bintik yang berwarna hitam.","Bunga Rafflesia berbau busuk seperti bau daging atau bangkai yang reput.","Bau harum yang dihasilkan oleh bunga Rafflesia dapat menarik perhatian serangga dan hidupan lain."],"a":2},
                {"y":"mcq","s":"Berikut ialah ciri-ciri bunga Rafflesia yang terdapat dalam teks petikan, kecuali","o":["Bunga ini menghasilkan bau yang harum.","Bunga ini amat besar dan warnanya kecokelatan.","Bunga ini tidak berdaun, bersaiz besar, dan berat.","Serangga menjadi agen penyebar benih bunga Rafflesia."],"a":0}]},
                {"t":"A (Pemahaman Bahan 1 & 2)","i":"Baca bahan dan jawab.","c1":"Aminah dan rakan berlatih bercerita dua bulan. Pada hari pertandingan mereka bercerita dengan yakin. Dapat tempat kedua (RM400 +sijil).","c2":"Pertandingan Bercerita SR Bulan Bahasa 2025 15 Mei 8 pagi Dewan SK Maju • Juara RM700 • Terbuka Tahap 2.","q":[
                {"y":"mcq","s":"Aminah dan rakan bersedia kerana…","o":["bangga","berlatih dua bulan","mengharumkan sekolah","belum jelas"],"a":1},
                {"y":"mcq","s":"Penjodoh sesuai bagi 'sijil' ialah…","o":["keping","lembar","bidang","helai"],"a":0},
                {"y":"mcq","s":"Sinonim 'pertandingan' ialah…","o":["penghargaan","peraduan","penyertaan","perlawanan"],"a":1},
                {"y":"mcq","s":"Pernyataan benar tentang Bahan 1 & 2.","o":["Aminah dan rakan menang RM700 dalam pertandingan.","Pertandingan bercerita terbuka untuk murid Tahap 2.","Pertandingan yang diadakan adalah deklamasi sajak.","Juara pertandingan akan menerima hadiah RM400."],"a":1}]},
                {"t":"B (Tatabahasa dan Pemahaman Petikan)","i":"Baca petikan dan jawab (a–d).","c":"Ibu Danish ada kereta Perodua Bezza dibeli di Kuantan Pahang berwarna biru. Kereta itu diguna ke tempat kerja dan hantar nenek ke klinik. Setiap Sabtu ibu Danish mencuci serta menggilap kereta itu.","q":[
                {"y":"text","s":"(a) Ibu Danish ada kereta berjenama ____.","acc":["perodua bezza","bezza"]},
                {"y":"order","s":"(b) Susun perkataan jadi jawapan — Apakah kegunaan kereta itu?","tok":["kereta","digunakan","untuk","pergi","ke","tempat","kerja","dan","menghantar","nenek","ke","klinik"],"key":"kereta digunakan untuk pergi ke tempat kerja dan menghantar nenek ke klinik"},
                {"y":"mcq","s":"(c) Pilih kata kerja dalam ayat ini: \"Ibu Danish mencuci dan menggilap kereta.\"","o":["mencuci","ibu","kereta","biru"],"a":0},
                {"y":"judge","s":"(d) Seret label BETUL atau SALAH ke setiap ayat di bawah berdasarkan sama ada ayat tersebut sama maksud dengan ayat yang diberikan.<br><strong>Ayat yang diberi:</strong> Urusan jual beli di setiap gerai jualan dilakukan dengan menggunakan kupon.","snt":[["Setiap gerai jualan menjual kupon yang digunakan dalam urusan jual beli.",0],["Kupon digunakan ketika urusan jual beli di setiap gerai jualan.",1]]}]}
            ]};
            
            // Transform raw data to internal format
            QUIZ_DATA = {
                set_id: rawData.set_id,
                sections: rawData.sections.map((section, sectionIndex) => ({
                    title: `Bahagian ${section.t}`,
                    instruction: section.i,
                    content: section.c,
                    content1: section.c1,
                    content2: section.c2,
                    items: (() => {
                        let allQuestions = [];
                        let questionIndex = 0;
                        
                        // Process main questions (q)
                        if (section.q) {
                            section.q.forEach(question => {
                                const questionId = `s${sectionIndex}_q${questionIndex}`;
                                const baseItem = {
                                    id: questionId,
                                    type: question.y,
                                    q: question.s,
                                    w: 1
                                };
                                
                                switch(question.y) {
                                    case 'mcq':
                                        allQuestions.push({
                                            ...baseItem,
                                            options: question.o.map((opt, i) => `${String.fromCharCode(65 + i)}) ${opt}`),
                                            key: String.fromCharCode(65 + question.a)
                                        });
                                        break;
                                    case 'text':
                                        allQuestions.push({
                                            ...baseItem,
                                            acc: question.acc
                                        });
                                        break;
                                    case 'order':
                                        allQuestions.push({
                                            ...baseItem,
                                            tokens: question.tok,
                                            key: question.key
                                        });
                                        break;
                                    case 'judge':
                                        allQuestions.push({
                                            ...baseItem,
                                            s: question.snt
                                        });
                                        break;
                                }
                                questionIndex++;
                            });
                        }
                        
                        return allQuestions;
                    })()
                }))
            };
        }

        function startQuiz() {
            console.log('startQuiz function called');
            
            const name = document.getElementById('studentName').value.trim();
            const className = document.getElementById('studentClass').value.trim();
            const school = document.getElementById('studentSchool').value.trim();
            
            console.log('Form values:', { name, className, school });
            
            if (!name || !className || !school) {
                showInlineMessage('Sila masukkan nama, kelas dan nama sekolah anda.', 'error');
                console.log('Validation failed - missing fields');
                return;
            }
            
            console.log('Validation passed, starting quiz...');
            
            quizData.nama = name;
            quizData.kelas = className;
            quizData.sekolah = school;
            
            try {
                console.log('Step 1: Initializing quiz data...');
                initializeQuizData();
                console.log('Quiz data initialized successfully:', QUIZ_DATA);
                
                console.log('Step 2: Generating questions...');
                generateQuestions();
                console.log('Questions generated successfully');
                
                console.log('Step 3: Switching screens...');
                const startScreen = document.getElementById('startScreen');
                const quizScreen = document.getElementById('quizScreen');
                const timer = document.getElementById('timer');
                
                console.log('Elements found:', { startScreen, quizScreen, timer });
                
                if (startScreen && quizScreen && timer) {
                    startScreen.classList.add('hidden');
                    quizScreen.classList.remove('hidden');
                    timer.classList.remove('hidden');
                    console.log('Screen switch completed');
                } else {
                    throw new Error('Required elements not found');
                }
                
                console.log('Step 4: Starting timer...');
                startTime = new Date();
                startTimer();
                console.log('Quiz started successfully at:', startTime);
                
                showInlineMessage('Kuiz telah dimulakan! Semoga berjaya!', 'success');
                
            } catch (error) {
                console.error('Error starting quiz:', error);
                console.error('Error stack:', error.stack);
                showInlineMessage(`Ralat memulakan kuiz: ${error.message}. Sila cuba lagi.`, 'error');
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsed = Math.floor((now - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                
                document.getElementById('timer').textContent = 
                    `⏱️ Masa: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function generateQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            let globalQuestionNumber = 1;
            
            QUIZ_DATA.sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section';
                
                let sectionHTML = `<div class="section-title">${section.title}</div>`;
                
                // Add instruction
                if (section.instruction) {
                    sectionHTML += `<div class="material"><p><strong>${section.instruction}</strong></p></div>`;
                }
                
                // Add content (for reading passages)
                if (section.content) {
                    sectionHTML += `<div class="material" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-top: 0;">Petikan:</h4>
                        <p>${section.content}</p>
                    </div>`;
                }
                
                // Add content1 and content2 (for dual materials)
                if (section.content1 && section.content2) {
                    sectionHTML += `
                        <div class="material" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                            <h4 style="color: #856404; margin-top: 0;">Bahan 1:</h4>
                            <p>${section.content1}</p>
                        </div>
                        <div class="material" style="background: #d1ecf1; border-left: 4px solid #17a2b8;">
                            <h4 style="color: #0c5460; margin-top: 0;">Bahan 2:</h4>
                            <p>${section.content2}</p>
                        </div>
                    `;
                }
                
                sectionDiv.innerHTML = sectionHTML;
                
                section.items.forEach((item, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-card';
                    
                    let questionHTML = `
                        <div class="question-number">Soalan ${globalQuestionNumber}:</div>
                        <p>${item.q}</p>
                    `;
                    
                    switch(item.type) {
                        case 'mcq':
                            questionHTML += generateMCQHTML(item);
                            break;
                        case 'text':
                            questionHTML += generateTextHTML(item);
                            break;
                        case 'order':
                            questionHTML += generateOrderHTML(item);
                            break;
                        case 'judge':
                            questionHTML += generateJudgeHTML(item);
                            break;
                    }
                    
                    questionDiv.innerHTML = questionHTML;
                    sectionDiv.appendChild(questionDiv);
                    globalQuestionNumber++;
                });
                
                container.appendChild(sectionDiv);
            });
            
            // Initialize interactive elements
            initializeOrderQuestions();
            initializeJudgeQuestions();
        }



        function generateMCQHTML(item) {
            return `
                <div class="mcq-options">
                    ${item.options.map(option => `
                        <div class="mcq-option">
                            <input type="radio" name="${item.id}" value="${option.charAt(0)}" id="${item.id}_${option.charAt(0)}">
                            <label for="${item.id}_${option.charAt(0)}">${option}</label>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateTextHTML(item) {
            return `
                <input type="text" class="text-input" id="${item.id}" placeholder="Masukkan jawapan anda di sini...">
            `;
        }

        function generateOrderHTML(item) {
            return `
                <div class="order-container" data-question-id="${item.id}">
                    <div class="order-labels">
                        <div><strong>Perkataan yang tersedia:</strong></div>
                    </div>
                    <div class="tokens-available" id="${item.id}_available">
                        ${item.tokens.map(token => `
                            <span class="token" data-token="${token}">${token}</span>
                        `).join('')}
                    </div>
                    <div class="order-labels">
                        <div><strong>Susunan jawapan anda:</strong></div>
                    </div>
                    <div class="tokens-selected" id="${item.id}_selected">
                        <em>Klik perkataan di atas untuk menyusun jawapan</em>
                    </div>
                </div>
            `;
        }

        function generateJudgeHTML(item) {
            return `
                <div class="judge-container" data-question-id="${item.id}">
                    <div class="judge-labels">
                        <div class="judge-label" draggable="true" data-value="1">BETUL</div>
                        <div class="judge-label false" draggable="true" data-value="0">SALAH</div>
                    </div>
                    <div class="judge-statements">
                        ${item.s.map((statement, index) => `
                            <div class="judge-statement" data-statement-index="${index}">
                                <span>${statement[0]}</span>
                                <div class="drop-zone"></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function initializeOrderQuestions() {
            document.querySelectorAll('.order-container').forEach(container => {
                const questionId = container.dataset.questionId;
                const availableDiv = container.querySelector(`#${questionId}_available`);
                const selectedDiv = container.querySelector(`#${questionId}_selected`);
                
                availableDiv.addEventListener('click', (e) => {
                    if (e.target.classList.contains('token')) {
                        moveTokenToSelected(e.target, selectedDiv, availableDiv);
                    }
                });
                
                selectedDiv.addEventListener('click', (e) => {
                    if (e.target.classList.contains('token')) {
                        moveTokenToAvailable(e.target, availableDiv, selectedDiv);
                    }
                });
            });
        }

        function moveTokenToSelected(token, selectedDiv, availableDiv) {
            const clonedToken = token.cloneNode(true);
            clonedToken.classList.add('selected');
            
            if (selectedDiv.querySelector('em')) {
                selectedDiv.innerHTML = '';
            }
            
            selectedDiv.appendChild(clonedToken);
            token.remove();
        }

        function moveTokenToAvailable(token, availableDiv, selectedDiv) {
            const clonedToken = token.cloneNode(true);
            clonedToken.classList.remove('selected');
            
            availableDiv.appendChild(clonedToken);
            token.remove();
            
            if (selectedDiv.children.length === 0) {
                selectedDiv.innerHTML = '<em>Klik perkataan di atas untuk menyusun jawapan</em>';
            }
        }

        function initializeJudgeQuestions() {
            document.querySelectorAll('.judge-container').forEach(container => {
                const labels = container.querySelectorAll('.judge-label');
                const statements = container.querySelectorAll('.judge-statement');
                
                labels.forEach(label => {
                    label.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', label.dataset.value);
                        e.dataTransfer.setData('text/html', label.outerHTML);
                        label.classList.add('dragging');
                    });
                    
                    label.addEventListener('dragend', () => {
                        label.classList.remove('dragging');
                    });
                });
                
                statements.forEach(statement => {
                    statement.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        statement.classList.add('drag-over');
                    });
                    
                    statement.addEventListener('dragleave', () => {
                        statement.classList.remove('drag-over');
                    });
                    
                    statement.addEventListener('drop', (e) => {
                        e.preventDefault();
                        statement.classList.remove('drag-over');
                        
                        const value = e.dataTransfer.getData('text/plain');
                        const labelHTML = e.dataTransfer.getData('text/html');
                        
                        const dropZone = statement.querySelector('.drop-zone');
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = labelHTML;
                        const newLabel = tempDiv.firstChild;
                        newLabel.classList.add('assigned-label');
                        newLabel.draggable = false;
                        
                        dropZone.innerHTML = '';
                        dropZone.appendChild(newLabel);
                    });
                });
            });
        }

        function collectAnswers() {
            userAnswers = {};
            
            QUIZ_DATA.sections.forEach(section => {
                section.items.forEach(item => {
                    switch(item.type) {
                        case 'mcq':
                            const selectedOption = document.querySelector(`input[name="${item.id}"]:checked`);
                            userAnswers[item.id] = selectedOption ? selectedOption.value : '';
                            break;
                            
                        case 'text':
                            const textInput = document.getElementById(item.id);
                            userAnswers[item.id] = textInput.value.trim();
                            break;
                            
                        case 'order':
                            const selectedTokens = document.querySelectorAll(`#${item.id}_selected .token`);
                            const tokens = Array.from(selectedTokens).map(token => token.dataset.token);
                            userAnswers[item.id] = tokens.join(' ').toLowerCase();
                            break;
                            
                        case 'judge':
                            const container = document.querySelector(`[data-question-id="${item.id}"]`);
                            const statements = container.querySelectorAll('.judge-statement');
                            const judgments = [];
                            
                            statements.forEach(statement => {
                                const assignedLabel = statement.querySelector('.assigned-label');
                                const value = assignedLabel ? assignedLabel.dataset.value : '';
                                judgments.push(value);
                            });
                            
                            userAnswers[item.id] = judgments;
                            break;
                    }
                });
            });
        }

        function calculateScore() {
            let totalScore = 0;
            let maxScore = 0;
            const results = [];
            
            QUIZ_DATA.sections.forEach(section => {
                section.items.forEach(item => {
                    const weight = item.w || 1;
                    maxScore += weight;
                    
                    let isCorrect = false;
                    const userAnswer = userAnswers[item.id];
                    
                    switch(item.type) {
                        case 'mcq':
                            isCorrect = userAnswer === item.key;
                            break;
                            
                        case 'text':
                            const acceptableAnswers = item.acc.map(ans => ans.toLowerCase().trim());
                            isCorrect = acceptableAnswers.includes(userAnswer.toLowerCase());
                            break;
                            
                        case 'order':
                            isCorrect = userAnswer === item.key.toLowerCase();
                            break;
                            
                        case 'judge':
                            const correctAnswers = item.s.map(s => s[1].toString());
                            isCorrect = JSON.stringify(userAnswer) === JSON.stringify(correctAnswers);
                            break;
                    }
                    
                    if (isCorrect) {
                        totalScore += weight;
                    }
                    
                    results.push({
                        q: item.id,
                        type: item.type,
                        value: userAnswer,
                        correct: getCorrectAnswer(item),
                        isCorrect: isCorrect
                    });
                });
            });
            
            return {
                score: totalScore,
                maxScore: maxScore,
                percent: Math.round((totalScore / maxScore) * 100),
                results: results
            };
        }

        function getCorrectAnswer(item) {
            switch(item.type) {
                case 'mcq':
                    return item.key;
                case 'text':
                    return item.acc.join(' / ');
                case 'order':
                    return item.key;
                case 'judge':
                    return item.s.map(s => s[1] ? 'BETUL' : 'SALAH').join(', ');
                default:
                    return '';
            }
        }

        function submitQuiz() {
            // Stop timer
            clearInterval(timerInterval);
            const endTime = new Date();
            const duration = Math.floor((endTime - startTime) / 1000);
            
            // Collect answers
            collectAnswers();
            
            // Calculate score
            const scoreData = calculateScore();
            
            // Store results
            quizData.score = scoreData.score;
            quizData.maxScore = scoreData.maxScore;
            quizData.percent = scoreData.percent;
            quizData.duration_sec = duration;
            quizData.results = scoreData.results;
            
            // Display results
            displayResults(scoreData, duration);
            
            // Send to Google Sheets
            sendToGoogleSheets();
            
            // Switch to results screen
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
        }

        function displayResults(scoreData, duration) {
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            
            document.getElementById('scoreDisplay').textContent = 
                `${scoreData.score}/${scoreData.maxScore} (${scoreData.percent}%)`;
            document.getElementById('timeDisplay').innerHTML = 
                `<p><strong>Masa Diambil:</strong> ${minutes} minit ${seconds} saat</p>`;
            
            let detailsHTML = '<h3>Butiran Jawapan:</h3>';
            
            scoreData.results.forEach((result, index) => {
                const resultClass = result.isCorrect ? 'correct' : 'incorrect';
                const icon = result.isCorrect ? '✅' : '❌';
                
                detailsHTML += `
                    <div class="result-item ${resultClass}">
                        <strong>${icon} Soalan ${index + 1} (${result.type.toUpperCase()}):</strong><br>
                        <strong>Jawapan Anda:</strong> ${formatUserAnswer(result.value, result.type)}<br>
                        <strong>Jawapan Betul:</strong> ${result.correct}
                    </div>
                `;
            });
            
            document.getElementById('detailedResults').innerHTML = detailsHTML;
        }

        function formatUserAnswer(value, type) {
            if (!value || (Array.isArray(value) && value.length === 0)) {
                return 'Tidak dijawab';
            }
            
            if (type === 'judge' && Array.isArray(value)) {
                return value.map(v => v === '1' ? 'BETUL' : v === '0' ? 'SALAH' : 'Tidak dijawab').join(', ');
            }
            
            return value.toString();
        }

        function sendToGoogleSheets() {
            const duration = quizData.duration_sec;
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            const timeFormatted = `${minutes} minit ${seconds} saat`;
            
            const payload = {
                nama: quizData.nama,
                kelas: quizData.kelas,
                sekolah: quizData.sekolah,
                masa: timeFormatted,
                markah: `${quizData.score}/${quizData.maxScore}`,
                peratus: `${quizData.percent}%`
            };
            
            if (WEB_APP_URL && WEB_APP_URL !== "PASTE_GOOGLE_APPS_SCRIPT_WEB_APP_URL") {
                fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                }).then(() => {
                    console.log('Data berjaya dihantar ke Google Sheets');
                }).catch(error => {
                    console.log('Data sedang dihantar ke Google Sheets...');
                });
            }
        }

        function showReviewScreen() {
            // Generate review content
            generateReviewContent();
            
            // Switch to review screen
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('reviewScreen').classList.remove('hidden');
        }

        function generateReviewContent() {
            const container = document.getElementById('reviewContainer');
            container.innerHTML = '';
            
            let globalQuestionNumber = 1;
            
            QUIZ_DATA.sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section';
                
                let sectionHTML = `<div class="section-title">${section.title}</div>`;
                
                // Add instruction
                if (section.instruction) {
                    sectionHTML += `<div class="material"><p><strong>${section.instruction}</strong></p></div>`;
                }
                
                // Add content (for reading passages)
                if (section.content) {
                    sectionHTML += `<div class="material" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-top: 0;">Petikan:</h4>
                        <p>${section.content}</p>
                    </div>`;
                }
                
                // Add content1 and content2 (for dual materials)
                if (section.content1 && section.content2) {
                    sectionHTML += `
                        <div class="material" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                            <h4 style="color: #856404; margin-top: 0;">Bahan 1:</h4>
                            <p>${section.content1}</p>
                        </div>
                        <div class="material" style="background: #d1ecf1; border-left: 4px solid #17a2b8;">
                            <h4 style="color: #0c5460; margin-top: 0;">Bahan 2:</h4>
                            <p>${section.content2}</p>
                        </div>
                    `;
                }
                
                sectionDiv.innerHTML = sectionHTML;
                
                section.items.forEach((item, index) => {
                    const result = quizData.results.find(r => r.q === item.id);
                    const isCorrect = result ? result.isCorrect : false;
                    
                    const reviewDiv = document.createElement('div');
                    reviewDiv.className = `review-question ${isCorrect ? 'correct' : 'incorrect'}`;
                    
                    let reviewHTML = `
                        <div class="review-header">
                            <span>Soalan ${globalQuestionNumber}:</span>
                            <span class="review-status ${isCorrect ? 'correct' : 'incorrect'}">
                                ${isCorrect ? '✅ Betul' : '❌ Salah'}
                            </span>
                        </div>
                        <div class="review-content">
                            <p><strong>${item.q}</strong></p>
                            ${generateReviewAnswerHTML(item, result)}
                        </div>
                    `;
                    
                    reviewDiv.innerHTML = reviewHTML;
                    sectionDiv.appendChild(reviewDiv);
                    globalQuestionNumber++;
                });
                
                container.appendChild(sectionDiv);
            });
        }

        function generateReviewAnswerHTML(item, result) {
            const userAnswer = result ? result.value : '';
            const correctAnswer = getCorrectAnswer(item);
            
            let html = '<div class="review-answers">';
            
            switch(item.type) {
                case 'mcq':
                    html += `
                        <div class="user-answer">
                            <span class="answer-label">Jawapan Anda:</span>
                            ${formatUserAnswer(userAnswer, item.type)}
                        </div>
                        <div class="correct-answer">
                            <span class="answer-label">Jawapan Betul:</span>
                            ${correctAnswer}
                        </div>
                        <div class="review-options">
                            ${item.options.map(option => {
                                const optionLetter = option.charAt(0);
                                let optionClass = '';
                                
                                if (userAnswer === optionLetter && correctAnswer === optionLetter) {
                                    optionClass = 'both-selected';
                                } else if (correctAnswer === optionLetter) {
                                    optionClass = 'correct-answer';
                                } else if (userAnswer === optionLetter) {
                                    optionClass = 'user-selected';
                                }
                                
                                return `<div class="review-option ${optionClass}">${option}</div>`;
                            }).join('')}
                        </div>
                    `;
                    break;
                    
                case 'text':
                    html += `
                        <div class="user-answer">
                            <span class="answer-label">Jawapan Anda:</span>
                            "${formatUserAnswer(userAnswer, item.type)}"
                        </div>
                        <div class="correct-answer">
                            <span class="answer-label">Jawapan Betul:</span>
                            ${correctAnswer}
                        </div>
                    `;
                    break;
                    
                case 'order':
                    html += `
                        <div class="user-answer">
                            <span class="answer-label">Susunan Anda:</span>
                            "${formatUserAnswer(userAnswer, item.type)}"
                        </div>
                        <div class="correct-answer">
                            <span class="answer-label">Susunan Betul:</span>
                            "${correctAnswer}"
                        </div>
                    `;
                    break;
                    
                case 'judge':
                    html += `
                        <div class="user-answer">
                            <span class="answer-label">Penilaian Anda:</span>
                            ${formatUserAnswer(userAnswer, item.type)}
                        </div>
                        <div class="correct-answer">
                            <span class="answer-label">Penilaian Betul:</span>
                            ${correctAnswer}
                        </div>
                        <div style="margin-top: 10px;">
                            ${item.s.map((statement, index) => {
                                const userJudgment = Array.isArray(userAnswer) && userAnswer[index] ? 
                                    (userAnswer[index] === '1' ? 'BETUL' : userAnswer[index] === '0' ? 'SALAH' : 'Tidak dijawab') : 'Tidak dijawab';
                                const correctJudgment = statement[1] ? 'BETUL' : 'SALAH';
                                const isStatementCorrect = userJudgment === correctJudgment;
                                
                                return `
                                    <div style="margin-bottom: 8px; padding: 8px; border-radius: 5px; ${isStatementCorrect ? 'background: #e8f5e8; border: 1px solid #4CAF50;' : 'background: #ffebee; border: 1px solid #f44336;'}">
                                        <div style="margin-bottom: 5px;"><strong>Ayat ${index + 1}:</strong> ${statement[0]}</div>
                                        <div style="font-size: 14px;">
                                            <span style="color: ${isStatementCorrect ? '#4CAF50' : '#f44336'};">Anda: ${userJudgment}</span> | 
                                            <span style="color: #4CAF50;">Betul: ${correctJudgment}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    break;
            }
            
            html += '</div>';
            return html;
        }

        function backToResults() {
            document.getElementById('reviewScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
        }

        function tryAgain() {
            // Reset all inputs
            document.getElementById('studentName').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('studentSchool').value = '';
            
            // Reset variables
            quizData = {};
            userAnswers = {};
            clearInterval(timerInterval);
            
            // Return to start screen
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('reviewScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('timer').classList.add('hidden');
        }

        function printResults() {
            window.print();
        }

        function showInlineMessage(message, type = 'info') {
            // Create inline message instead of alert
            const messageDiv = document.createElement('div');
            
            let bgColor, textColor, borderColor;
            switch(type) {
                case 'error':
                    bgColor = '#ffebee';
                    textColor = '#c62828';
                    borderColor = '#f44336';
                    break;
                case 'success':
                    bgColor = '#e8f5e8';
                    textColor = '#2e7d32';
                    borderColor = '#4caf50';
                    break;
                default:
                    bgColor = '#e3f2fd';
                    textColor = '#1565c0';
                    borderColor = '#2196F3';
            }
            
            messageDiv.style.cssText = `
                background: ${bgColor};
                color: ${textColor};
                padding: 12px;
                border-radius: 8px;
                margin: 10px 0;
                border-left: 4px solid ${borderColor};
                font-weight: bold;
            `;
            messageDiv.textContent = message;
            
            const startScreen = document.getElementById('startScreen');
            const existingMessage = startScreen.querySelector('.inline-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            messageDiv.className = 'inline-message';
            startScreen.insertBefore(messageDiv, startScreen.querySelector('.form-group'));
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, type === 'success' ? 2000 : 5000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for buttons
            document.getElementById('startQuizBtn').addEventListener('click', startQuiz);
            
            // Add event listener for submit button (will be added dynamically)
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'submitQuizBtn') {
                    submitQuiz();
                }
                if (e.target && e.target.id === 'tryAgainBtn') {
                    tryAgain();
                }
                if (e.target && e.target.id === 'tryAgainFromReviewBtn') {
                    tryAgain();
                }
                if (e.target && e.target.id === 'printResultsBtn') {
                    printResults();
                }
                if (e.target && e.target.id === 'reviewAnswersBtn') {
                    showReviewScreen();
                }
                if (e.target && e.target.id === 'backToResultsBtn') {
                    backToResults();
                }
            });
            
            // Quiz will be ready when JSON data is provided
            console.log('Kuiz Interaktif BM Tahun 4 siap digunakan!');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99395d4c929b4bc5',t:'MTc2MTMwNzc1Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
